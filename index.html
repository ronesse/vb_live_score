<script>
  /* ---------- FAVORITTLAG ---------- */
  const teams = [
    { id: 458327, name: "Selver/TalTech", volleyboxSlug: "selver-tallinn-t357" },
    { id: 122228, name: "CDV Rio Duero Soria", volleyboxSlug: "rio-duero-soria-t3694" },
    { id: 44675,  name: "Tourcoing VB Lille M√©tropole", volleyboxSlug: "tourcoing-vlm-t248" },
    { id: 273828, name: "Knack Roeselare", volleyboxSlug: "knack-roeselare-t1579" },
    { id: 447293, name: "Prima Donna Kaas Huizen", volleyboxSlug: "prima-donna-kaas-huizen-t12094" },
    { id: 183831, name: "ASV Arhus", volleyboxSlug: "asv-elite-t4364" },
    { id: 209169, name: "Nordenskov Uif", volleyboxSlug: "nordenskov-uif-t6594" },
    { id: 107699, name: "BBTS Bielsko-Bia≈Ça", volleyboxSlug: "bbts-bielsko-biala-t1358" },
    { id: 56111, name: "Trefl Gdansk", volleyboxSlug: "trefl-gdansk-t1897" }
  ];

  /* ---------- NORSKE SPILLERE ---------- */
  const norwegianPlayersMap = {
    "selver-tallinn-t357": [{ name: "Mads Roness", url: "https://volleybox.net/mads-roness-p60414" }],
    "rio-duero-soria-t3694": [{ name: "Mikal Kalstad", url: "https://volleybox.net/mikal-kalstad-p158538/clubs" }],
    "tourcoing-vlm-t248": [{ name: "Eskil Eng√•s", url: "https://volleybox.net/eskil-engs-p157395/clubs" }],
    "knack-roeselare-t1579": [{ name: "Oskar Espeland", url: "https://volleybox.net/oskar-espeland-p44340/clubs" }],
    "prima-donna-kaas-huizen-t12094": [
      { name: "Samson Olsen", url: "https://volleybox.net/samson-olsen-p58498/clubs" },
      { name: "Lars-Kristian Ekeland", url: "https://volleybox.net/lars-kristian-ekeland-p53712/clubs" }
    ],
    "asv-elite-t4364": [{ name: "Frithjof Moe Slinning", url: "https://volleybox.net/frithjof-moe-slinning-p158535/clubs" }],
    "bbts-bielsko-biala-t1358": [{ name: "Jakob Solgaard Thelle", url: "https://volleybox.net/jakob-solgaard-thelle-p17581/clubs" }],
    "nordenskov-uif-t6594": [{ name: "Peder Senumstad", url: "" }]
  };

  const proxy = "https://corsproxy.io/?";

  function searchLink(name) {
    return `https://www.google.com/search?q=${encodeURIComponent('site:volleybox.net ' + name)}`;
  }

  function renderPlayers(players) {
    if (!players || players.length === 0) {
      return `<div class="player"><em>Ingen üá≥üá¥ spillere</em></div>`;
    }
    return players.map(p => {
      const label = `üá≥üá¥ ${p.name}`;
      if (p.url && p.url.trim().length > 0) {
        return `<div class="player"><a href="${p.url}" target="_blank">${label}</a></div>`;
      }
      return `<div class="player">${label} <a href="${searchLink(p.name)}" target="_blank">üîé</a></div>`;
    }).join("");
  }

  async function fetchJSON(url) {
    const resp = await fetch(proxy + url);
    if (!resp.ok) throw new Error("Feil ved henting fra " + url);
    return await resp.json();
  }

  async function fetchLive() {
    const data = await fetchJSON("https://api.sofascore.com/api/v1/sport/volleyball/events/live");
    return data.events || [];
  }

  async function fetchNextForTeam(teamId) {
    const data = await fetchJSON(`https://api.sofascore.com/api/v1/team/${teamId}/events/next/0`);
    return data.events?.[0] || null;
  }

  async function fetchEventDetails(eventId) {
    try {
      const data = await fetchJSON(`https://api.sofascore.com/api/v1/event/${eventId}`);
      return data.event;
    } catch { return null; }
  }

  async function updateLive() {
    const container = document.getElementById("live");
    try {
      const events = await fetchLive();
      const myEvents = events.filter(e =>
        teams.some(t => t.id === e.homeTeam.id || t.id === e.awayTeam.id)
      );

      if (myEvents.length === 0) {
        container.innerHTML = "<p>Ingen p√•g√•ende kamper n√•.</p>";
        return;
      }

      const detailedEvents = await Promise.all(myEvents.map(e => fetchEventDetails(e.id)));
      container.innerHTML = detailedEvents.map(e => {
        const h = e.homeTeam.name, a = e.awayTeam.name;
        const logoH = `https://api.sofascore.com/api/v1/team/${e.homeTeam.id}/image`;
        const logoA = `https://api.sofascore.com/api/v1/team/${e.awayTeam.id}/image`;
        const liveHome = e.homeScore?.display ?? "-";
        const liveAway = e.awayScore?.display ?? "-";
        const sets = [];
        for (let i = 1; i <= 5; i++) {
          const hs = e.homeScore?.[`period${i}`];
          const as = e.awayScore?.[`period${i}`];
          if (hs !== undefined && as !== undefined) sets.push(`${i}. sett: ${hs}-${as}`);
        }
        const activeSetHTML = sets.length ? `<div class="active-set">${sets.at(-1)}</div>` : "";
        const homePlayerHTML = renderPlayers(norwegianPlayersMap[teams.find(t => t.id === e.homeTeam.id)?.volleyboxSlug] || []);
        const awayPlayerHTML = renderPlayers(norwegianPlayersMap[teams.find(t => t.id === e.awayTeam.id)?.volleyboxSlug] || []);

        return `
          <div class="match">
            <div class="team">
              <div class="team-row">
                <img src="${logoH}" alt="${h}">
                <div>${h}</div>
              </div>
              ${homePlayerHTML}
            </div>
            <div class="score">
              üî• <span class="live">LIVE</span><br>
              ${liveHome} ‚Äì ${liveAway}
              ${activeSetHTML}
              <div class="sets">${sets.slice(0,-1).join("<br>")}</div>
            </div>
            <div class="team">
              <div class="team-row">
                <div>${a}</div>
                <img src="${logoA}" alt="${a}">
              </div>
              ${awayPlayerHTML}
            </div>
          </div>`;
      }).join("");
    } catch (err) {
      console.error(err);
      container.innerHTML = "<p>Kunne ikke hente live-data.</p>";
    }
  }

  function formatCountdown(secondsLeft) {
    if (secondsLeft <= 0) return "üèê Kampen starter n√•!";
    const d = Math.floor(secondsLeft / 86400);
    const h = Math.floor((secondsLeft % 86400) / 3600);
    const m = Math.floor((secondsLeft % 3600) / 60);
    const s = secondsLeft % 60;
    if (d > 0) return `${d} d ${h} t ${m} m`;
    if (h > 0) return `${h} t ${m} m ${s} s`;
    return `${m} m ${s} s`;
  }

  function updateCountdowns() {
    document.querySelectorAll(".countdown[data-ts]").forEach(el => {
      const ts = parseInt(el.getAttribute("data-ts"));
      const diff = Math.floor(ts - Date.now() / 1000);
      el.textContent = formatCountdown(diff);
      el.classList.remove("warning","critical");
      if (diff < 600) el.classList.add("critical");
      else if (diff < 3600) el.classList.add("warning");
    });
  }

  async function updateUpcoming() {
    const container = document.getElementById("upcoming");
    container.innerHTML = "";
    const allEvents = [];
    for (const team of teams) {
      try {
        const event = await fetchNextForTeam(team.id);
        if (event) allEvents.push({ event, team });
      } catch (err) { console.error(err); }
    }
    allEvents.sort((a, b) => a.event.startTimestamp - b.event.startTimestamp);
    for (const { event } of allEvents) {
      const h = event.homeTeam.name, a = event.awayTeam.name;
      const logoH = `https://api.sofascore.com/api/v1/team/${event.homeTeam.id}/image`;
      const logoA = `https://api.sofascore.com/api/v1/team/${event.awayTeam.id}/image`;
      const ts = event.startTimestamp;
      const time = new Date(ts * 1000).toLocaleString("no-NO", { dateStyle: "short", timeStyle: "short" });
      const homePlayerHTML = renderPlayers(norwegianPlayersMap[teams.find(t => t.id === event.homeTeam.id)?.volleyboxSlug] || []);
      const awayPlayerHTML = renderPlayers(norwegianPlayersMap[teams.find(t => t.id === event.awayTeam.id)?.volleyboxSlug] || []);

      container.innerHTML += `
        <div class="match">
          <div class="team">
            <div class="team-row"><img src="${logoH}" alt="${h}"><div>${h}</div></div>
            ${homePlayerHTML}
          </div>
          <div class="score">
            ${time}
            <div class="countdown-container">
              <div>‚è∞ Starter om:</div>
              <div class="countdown" data-ts="${ts}">Laster ‚Ä¶</div>
            </div>
          </div>
          <div class="team">
            <div class="team-row"><div>${a}</div><img src="${logoA}" alt="${a}"></div>
            ${awayPlayerHTML}
          </div>
        </div>`;
    }
    updateCountdowns();
  }

  updateLive();
  updateUpcoming();
  setInterval(updateLive, 3000);
  setInterval(updateUpcoming, 5 * 60 * 1000);
  setInterval(updateCountdowns, 1000);
</script>
