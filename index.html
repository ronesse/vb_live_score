<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üèê Volleyball ‚Äì Norske spillere i utlandet</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(180deg, #f3f6fa 0%, #ffffff 100%);
      color: #222;
      margin: 0;
      padding: 16px;
      max-width: 900px;
      margin-inline: auto;
    }
    h1, h2 {
      text-align: center;
      margin: 0 0 20px 0;
    }
    .section { margin-top: 30px; }

    .match {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      padding: 12px 16px;
      margin-bottom: 16px;
      transition: 0.2s ease;
    }
    .match:hover { transform: scale(1.01); }

    .team {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 30%;
    }
    .team-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .team img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid #ccc;
      object-fit: contain;
      background: #fff;
    }

    .player {
      font-size: 0.9em;
      color: #004;
      margin-top: 4px;
    }
    .player a {
      color: #0047AB;
      text-decoration: none;
    }
    .player a:hover { text-decoration: underline; }

    .score {
      font-weight: bold;
      text-align: center;
      flex: 0.4;
    }
    .live { color: #d00; font-weight: bold; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.4; } }

    .sets { font-size: 0.9em; margin-top: 6px; color: #333; }
    .active-set {
      background: #d00;
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 6px;
      margin-top: 6px;
      display: inline-block;
    }
    .status {
      font-style: italic;
      font-size: 0.85em;
      color: #555;
      text-align: center;
    }

    .countdown-container {
      margin-top: 4px;
      text-align: center;
      font-size: 0.95em;
    }
    .countdown {
      display: block;
      margin-top: 2px;
      font-weight: bold;
    }
    .countdown.warning { color: orange; }
    .countdown.critical { color: red; }

    @media (max-width: 700px) {
      .match { flex-direction: column; text-align: center; }
      .team { width: 100%; }
      .score { flex: 1 1 100%; margin: 10px 0; }
      .active-set { font-size: 1em; }
      .team-row { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <h1>üèê Volleyball ‚Äì Norske spillere i utlandet</h1>

  <div class="section">
    <h2>üî¥ Live kamper</h2>
    <div id="live">Laster ‚Ä¶</div>
  </div>

  <div class="section">
    <h2>üìÖ Neste kamper + Norske spillere üá≥üá¥</h2>
    <div id="upcoming">Laster ‚Ä¶</div>
  </div>

  <script>
    /* ---------- PROXY ---------- */
    const proxyBase = "https://api.codetabs.com/v1/proxy?quest=";

    async function fetchJSON(url) {
      try {
        const fullUrl = proxyBase + encodeURIComponent(url);
        const resp = await fetch(fullUrl);
        if (!resp.ok) throw new Error(`HTTP-feil: ${resp.status}`);
        console.log("‚úÖ Hentet via proxy:", url);
        return await resp.json();
      } catch (err) {
        console.error("‚ùå fetchJSON-feil:", err);
        const liveContainer = document.getElementById("live");
        if (liveContainer) {
          liveContainer.innerHTML = "<p style='color:red;'>Kunne ikke hente data (proxy-feil).</p>";
        }
        throw err;
      }
    }

    const teams = [
      { id: 458327, name: "Selver/TalTech", volleyboxSlug: "selver-tallinn-t357" },
      { id: 122228, name: "CDV Rio Duero Soria", volleyboxSlug: "rio-duero-soria-t3694" },
      { id: 44675,  name: "Tourcoing VB Lille M√©tropole", volleyboxSlug: "tourcoing-vlm-t248" },
      { id: 273828, name: "Knack Roeselare", volleyboxSlug: "knack-roeselare-t1579" },
      { id: 447293, name: "Prima Donna Kaas Huizen", volleyboxSlug: "prima-donna-kaas-huizen-t12094" },
      { id: 183831, name: "ASV Arhus", volleyboxSlug: "asv-elite-t4364" },
      { id: 209169, name: "Nordenskov Uif", volleyboxSlug: "nordenskov-uif-t6594" },
      { id: 107699, name: "BBTS Bielsko-Bia≈Ça", volleyboxSlug: "bbts-bielsko-biala-t1358" },
      { id: 56111, name: "Trefl Gdansk", volleyboxSlug: "trefl-gdansk-t1897" }
    ];

    const norwegianPlayersMap = {
      "selver-tallinn-t357": [{ name: "Mads Roness", url: "https://volleybox.net/mads-roness-p60414" }],
      "rio-duero-soria-t3694": [{ name: "Mikal Kalstad", url: "https://volleybox.net/mikal-kalstad-p158538/clubs" }],
      "tourcoing-vlm-t248": [{ name: "Eskil Eng√•s", url: "https://volleybox.net/eskil-engs-p157395/clubs" }],
      "knack-roeselare-t1579": [{ name: "Oskar Espeland", url: "https://volleybox.net/oskar-espeland-p44340/clubs" }],
      "prima-donna-kaas-huizen-t12094": [
        { name: "Samson Olsen", url: "https://volleybox.net/samson-olsen-p58498/clubs" },
        { name: "Lars-Kristian Ekeland", url: "https://volleybox.net/lars-kristian-ekeland-p53712/clubs" }
      ],
      "asv-elite-t4364": [{ name: "Frithjof Moe Slinning", url: "https://volleybox.net/frithjof-moe-slinning-p158535/clubs" }],
      "bbts-bielsko-biala-t1358": [{ name: "Jakob Solgaard Thelle", url: "https://volleybox.net/jakob-solgaard-thelle-p17581/clubs" }],
      "nordenskov-uif-t6594": [{ name: "Peder Senumstad", url: "" }]
    };

    function renderPlayers(players) {
      if (!players || players.length === 0) {
        return `<div class="player"><em>Ingen üá≥üá¥ spillere</em></div>`;
      }
      return players.map(p => {
        const label = `üá≥üá¥ ${p.name}`;
        return p.url && p.url.trim().length > 0
          ? `<div class="player"><a href="${p.url}" target="_blank">${label}</a></div>`
          : `<div class="player">${label}</div>`;
      }).join("");
    }

    async function fetchLive() {
      const data = await fetchJSON("https://api.sofascore.com/api/v1/sport/volleyball/events/live");
      return data.events || [];
    }

    async function fetchNextForTeam(teamId) {
      const data = await fetchJSON(`https://api.sofascore.com/api/v1/team/${teamId}/events/next/0`);
      return data.events?.[0] || null;
    }

    async function fetchEventDetails(eventId) {
      try {
        const data = await fetchJSON(`https://api.sofascore.com/api/v1/event/${eventId}`);
        return data.event;
      } catch { return null; }
    }

    async function updateLive() {
      const container = document.getElementById("live");
      try {
        const events = await fetchLive();
        const myEvents = events.filter(e =>
          teams.some(t => t.id === e.homeTeam.id || t.id === e.awayTeam.id)
        );
        if (myEvents.length === 0) {
          container.innerHTML = "<p>Ingen p√•g√•ende kamper n√•.</p>";
          return;
        }
        const detailedEvents = await Promise.all(myEvents.map(e => fetchEventDetails(e.id)));
        container.innerHTML = detailedEvents.map(e => {
          const h = e.homeTeam.name, a = e.awayTeam.name;
          const logoH = `https://api.sofascore.com/api/v1/team/${e.homeTeam.id}/image`;
          const logoA = `https://api.sofascore.com/api/v1/team/${e.awayTeam.id}/image`;
          const liveHome = e.homeScore?.display ?? "-";
          const liveAway = e.awayScore?.display ?? "-";
          const sets = [];
          for (let i = 1; i <= 5; i++) {
            const hs = e.homeScore?.[`period${i}`];
            const as = e.awayScore?.[`period${i}`];
            if (hs !== undefined && as !== undefined) sets.push(`${i}. sett: ${hs}-${as}`);
          }
          const activeSetHTML = sets.length ? `<div class="active-set">${sets.at(-1)}</div>` : "";
          const homePlayerHTML = renderPlayers(norwegianPlayersMap[teams.find(t => t.id === e.homeTeam.id)?.volleyboxSlug] || []);
          const awayPlayerHTML = renderPlayers(norwegianPlayersMap[teams.find(t => t.id === e.awayTeam.id)?.volleyboxSlug] || []);

          return `
            <div class="match">
              <div class="team">
                <div class="team-row">
                  <img src="${logoH}" alt="${h}">
                  <div>${h}</div>
                </div>
                ${homePlayerHTML}
              </div>
              <div class="score">
                üî• <span class="live">LIVE</span><br>
                ${liveHome} ‚Äì ${liveAway}
                ${activeSetHTML}
                <div class="sets">${sets.slice(0,-1).join("<br>")}</div>
              </div>
              <div class="team">
                <div class="team-row">
                  <div>${a}</div>
                  <img src="${logoA}" alt="${a}">
                </div>
                ${awayPlayerHTML}
              </div>
            </div>`;
        }).join("");
      } catch (err) {
        console.error(err);
        container.innerHTML = "<p>Kunne ikke hente live-data.</p>";
      }
    }

    function formatCountdown(secondsLeft) {
      if (secondsLeft <= 0) return "üèê Kampen starter n√•!";
      const d = Math.floor(secondsLeft / 86400);
      const h = Math.floor((secondsLeft % 86400) / 3600);
      const m = Math.floor((secondsLeft % 3600) / 60);
      const s = secondsLeft % 60;
      if (d > 0) return `${d} d ${h} t ${m} m`;
      if (h > 0) return `${h} t ${m} m ${s} s`;
      return `${m} m ${s} s`;
    }

    function updateCountdowns() {
      document.querySelectorAll(".countdown[data-ts]").forEach(el => {
        const ts = parseInt(el.getAttribute("data-ts"));
        const diff = Math.floor(ts - Date.now() / 1000);
        el.textContent = formatCountdown(diff);
        el.classList.remove("warning","critical");
        if (diff < 600) el.classList.add("critical");
        else if (diff < 3600) el.classList.add("warning");
      });
    }

    async function updateUpcoming() {
      const container = document.getElementById("upcoming");
      container.innerHTML = "";
      const allEvents = [];
      for (const team of teams) {
        try {
          const event = await fetchNextForTeam(team.id);
          if (event) allEvents.push({ event, team });
        } catch (err) { console.error(err); }
      }
      allEvents.sort((a, b) => a.event.startTimestamp - b.event.startTimestamp);
      for (const { event } of allEvents) {
        const h = event.homeTeam.name, a = event.awayTeam.name;
        const logoH = `https://api.sofascore.com/api/v1/team/${event.homeTeam.id}/image`;
        const logoA = `https://api.sofascore.com/api/v1/team/${event.awayTeam.id}/image`;
        const ts = event.startTimestamp;
        const time = new Date(ts * 1000).toLocaleString("no-NO", { dateStyle: "short", timeStyle: "short" });
        const homePlayerHTML = renderPlayers(norwegianPlayersMap[teams.find(t => t.id === event.homeTeam.id)?.volleyboxSlug] || []);
        const awayPlayerHTML = renderPlayers(norwegianPlayersMap[teams.find(t => t.id === event.awayTeam.id)?.volleyboxSlug] || []);

        container.innerHTML += `
          <div class="match">
            <div class="team">
              <div class="team-row"><img src="${logoH}" alt="${h}"><div>${h}</div></div>
              ${homePlayerHTML}
            </div>
            <div class="score">
              ${time}
              <div class="countdown-container">
                <div>‚è∞ Starter om:</div>
                <div class="countdown" data-ts="${ts}">Laster ‚Ä¶</div>
              </div>
            </div>
            <div class="team">
              <div class="team-row"><div>${a}</div><img src="${logoA}" alt="${a}"></div>
              ${awayPlayerHTML}
            </div>
          </div>`;
      }
      updateCountdowns();
    }

    updateLive();
    updateUpcoming();
    setInterval(updateLive, 3000);
    setInterval(updateUpcoming, 5 * 60 * 1000);
    setInterval(updateCountdowns, 1000);
  </script>
</body>
</html>
